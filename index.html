<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Video Downloader Pro üé¨</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 700px;
      width: 100%;
      padding: 40px;
      animation: slideIn 0.5s ease;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    h1 {
      color: #333;
      font-size: 32px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .subtitle {
      color: #666;
      font-size: 14px;
    }

    .platforms {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin: 20px 0;
      flex-wrap: wrap;
    }

    .platform-badge {
      background: #f0f0f0;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 12px;
      color: #666;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .input-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      color: #333;
      font-weight: 600;
      margin-bottom: 10px;
      font-size: 14px;
    }

    input[type="text"] {
      width: 100%;
      padding: 15px;
      font-size: 16px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      transition: all 0.3s;
      outline: none;
      background: white;
    }

    input[type="text"]:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    /* NOVO: Estilo para bot√µes de tipo de m√≠dia */
    .media-type-buttons {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }

    .media-btn {
      padding: 15px 10px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      background: white;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 14px;
      font-weight: 500;
      color: #666;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
      text-align: center;
    }

    .media-btn:hover {
      border-color: #667eea;
      background: #f8f9ff;
      transform: translateY(-2px);
    }

    .media-btn.active {
      border-color: #667eea;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }

    .media-btn .icon {
      font-size: 24px;
    }

    .media-btn .title {
      font-weight: 600;
      font-size: 13px;
    }

    .media-btn .description {
      font-size: 11px;
      opacity: 0.8;
    }

    .browser-info {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
    }

    .browser-icon {
      font-size: 24px;
    }

    .browser-details {
      flex: 1;
    }

    .browser-name {
      font-weight: 600;
      color: #333;
    }

    .browser-path {
      font-size: 12px;
      color: #666;
      font-family: 'Courier New', monospace;
    }

    .download-btn {
      width: 100%;
      padding: 16px;
      font-size: 18px;
      font-weight: 600;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
    }

    .download-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
    }

    .download-btn:active:not(:disabled) {
      transform: translateY(0);
    }

    .download-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .download-btn .spinner {
      display: none;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    .download-btn.loading .spinner {
      display: block;
    }

    .download-btn.loading .btn-text {
      display: none;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .status-container {
      margin-top: 25px;
      display: none;
    }

    .status-container.show {
      display: block;
      animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .status-box {
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 15px;
    }

    .status-box.info {
      background: #e3f2fd;
      border-left: 4px solid #2196F3;
      color: #1565c0;
    }

    .status-box.success {
      background: #e8f5e9;
      border-left: 4px solid #4caf50;
      color: #2e7d32;
    }

    .status-box.error {
      background: #ffebee;
      border-left: 4px solid #f44336;
      color: #c62828;
    }

    .status-box.warning {
      background: #fff3e0;
      border-left: 4px solid #ff9800;
      color: #e65100;
    }

    .status-title {
      font-weight: 600;
      font-size: 16px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-message {
      font-size: 14px;
      line-height: 1.6;
    }

    .logs-container {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
      margin-top: 15px;
    }

    .log-line {
      padding: 3px 0;
      border-bottom: 1px solid #333;
    }

    .log-line:last-child {
      border-bottom: none;
    }

    .log-time {
      color: #858585;
      margin-right: 8px;
    }

    .log-info { color: #4fc3f7; }
    .log-success { color: #66bb6a; }
    .log-error { color: #ef5350; }
    .log-warning { color: #ffa726; }

    .download-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      background: #4caf50;
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-weight: 600;
      margin-top: 15px;
      transition: all 0.3s;
    }

    .download-link:hover {
      background: #45a049;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
    }

    .suggestions {
      margin-top: 15px;
    }

    .suggestion-item {
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 6px;
      margin: 8px 0;
      font-size: 13px;
      display: flex;
      align-items: start;
      gap: 8px;
    }

    .progress-bar {
      width: 100%;
      height: 4px;
      background: #e0e0e0;
      border-radius: 2px;
      overflow: hidden;
      margin-top: 15px;
      display: none;
    }

    .progress-bar.show {
      display: block;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      animation: progress 2s ease-in-out infinite;
    }

    @keyframes progress {
      0% { width: 0%; }
      50% { width: 70%; }
      100% { width: 100%; }
    }

    .footer {
      text-align: center;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #e0e0e0;
      color: #666;
      font-size: 12px;
    }

    /* Responsivo para telas menores */
    @media (max-width: 600px) {
      .media-type-buttons {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>
        <span>üé¨</span>
        <span>Video Downloader Pro</span>
      </h1>
      <p class="subtitle">Baixe v√≠deos de diversas plataformas com facilidade</p>
    </div>

    <div class="platforms">
      <span class="platform-badge">üì± TikTok</span>
      <span class="platform-badge">üì∏ Instagram</span>
      <span class="platform-badge">‚ñ∂Ô∏è YouTube</span>
      <span class="platform-badge">üìò Facebook</span>
      <span class="platform-badge">üìå Pinterest</span>
      <span class="platform-badge">üé• Vimeo</span>
    </div>

    <div class="input-group">
      <label for="videoUrl">üîó URL do V√≠deo</label>
      <input 
        type="text" 
        id="videoUrl" 
        placeholder="Cole aqui a URL do v√≠deo (ex: https://www.youtube.com/watch?v=...)"
        autocomplete="off"
      />
    </div>

    <!-- NOVO: Bot√µes para tipo de m√≠dia -->
    <div class="input-group">
      <label>üéµ Tipo de M√≠dia</label>
      <div class="media-type-buttons">
        <button class="media-btn active" data-type="video_audio">
          <span class="icon">üé¨</span>
          <span class="title">V√≠deo + √Åudio</span>
          <span class="description">Arquivo MP4 completo</span>
        </button>
        <button class="media-btn" data-type="audio_mp3">
          <span class="icon">üéµ</span>
          <span class="title">√Åudio MP3</span>
          <span class="description">Apenas m√∫sica/som</span>
        </button>
        <button class="media-btn" data-type="audio_m4a">
          <span class="icon">üéß</span>
          <span class="title">√Åudio M4A</span>
          <span class="description">Qualidade superior</span>
        </button>
        <button class="media-btn" data-type="video_only">
          <span class="icon">üìπ</span>
          <span class="title">Apenas V√≠deo</span>
          <span class="description">Sem √°udio</span>
        </button>
      </div>
    </div>

    <div class="browser-info" id="browserInfo">
      <span class="browser-icon" id="browserIcon">üåê</span>
      <div class="browser-details">
        <div class="browser-name" id="browserName">Detectando navegador...</div>
        <div class="browser-path" id="browserPath">Aguarde...</div>
      </div>
    </div>

    <button class="download-btn" id="downloadBtn">
      <span class="btn-text">‚¨áÔ∏è Baixar V√≠deo</span>
      <div class="spinner"></div>
    </button>

    <div class="progress-bar" id="progressBar">
      <div class="progress-fill"></div>
    </div>

    <div class="status-container" id="statusContainer">
      <div class="status-box" id="statusBox">
        <div class="status-title" id="statusTitle"></div>
        <div class="status-message" id="statusMessage"></div>
      </div>
      
      <div class="logs-container" id="logsContainer" style="display: none;">
        <div id="logs"></div>
      </div>
    </div>

    <div class="footer">
      <p>Desenvolvido com ‚ù§Ô∏è | Suporta m√∫ltiplas plataformas</p>
    </div>
  </div>

  <script>
    // VARI√ÅVEL GLOBAL para armazenar o navegador detectado
    let detectedBrowser = 'brave';
    let selectedMediaType = 'video_audio';

    // Configura√ß√£o de √≠cones por navegador
    const browserIcons = {
      brave: 'ü¶Å',
      chrome: 'üî¥',
      firefox: 'ü¶ä',
      edge: 'üî∑',
      safari: 'üß≠',
      chromium: '‚ö´'
    };

    const browserNames = {
      brave: 'Brave Browser',
      chrome: 'Google Chrome',
      firefox: 'Mozilla Firefox',
      edge: 'Microsoft Edge',
      safari: 'Safari',
      chromium: 'Chromium'
    };

    // Fun√ß√£o CORRIGIDA para detectar navegador (S√çNCRONA)
    function detectBrowser() {
      const userAgent = navigator.userAgent;

      // Detectar Brave via API
      if (navigator.brave) {
        console.log('‚úÖ Brave detectado via API');
        return 'brave';
      }

      // Detectar Edge
      if (userAgent.includes('Edg/')) {
        console.log('‚úÖ Edge detectado');
        return 'edge';
      }

      // Detectar Chrome (depois de verificar Edge e Brave)
      if (userAgent.includes('Chrome/')) {
        console.log('‚úÖ Chrome detectado');
        return 'chrome';
      }

      // Detectar Firefox
      if (userAgent.includes('Firefox/')) {
        console.log('‚úÖ Firefox detectado');
        return 'firefox';
      }

      // Detectar Safari
      if (userAgent.includes('Safari/') && !userAgent.includes('Chrome/')) {
        console.log('‚úÖ Safari detectado');
        return 'safari';
      }

      // Padr√£o
      console.log('‚ö†Ô∏è Navegador n√£o identificado, usando Brave como padr√£o');
      return 'brave';
    }

    // Adicionar log
    function addLog(message, type = 'info') {
      const logsContainer = document.getElementById('logs');
      const logsBox = document.getElementById('logsContainer');
      logsBox.style.display = 'block';

      const time = new Date().toLocaleTimeString('pt-BR');
      const logLine = document.createElement('div');
      logLine.className = `log-line log-${type}`;
      logLine.innerHTML = `<span class="log-time">[${time}]</span>${message}`;
      
      logsContainer.appendChild(logLine);
      logsContainer.scrollTop = logsContainer.scrollHeight;
    }

    // Atualizar status
    function updateStatus(title, message, type = 'info', suggestions = []) {
      const container = document.getElementById('statusContainer');
      const box = document.getElementById('statusBox');
      const titleEl = document.getElementById('statusTitle');
      const messageEl = document.getElementById('statusMessage');

      container.classList.add('show');
      box.className = `status-box ${type}`;

      const icons = {
        info: '‚ÑπÔ∏è',
        success: '‚úÖ',
        error: '‚ùå',
        warning: '‚ö†Ô∏è'
      };

      titleEl.innerHTML = `${icons[type]} ${title}`;
      messageEl.innerHTML = message;

      if (suggestions.length > 0) {
        const suggestionsHTML = suggestions.map(s => 
          `<div class="suggestion-item">üí° ${s}</div>`
        ).join('');
        messageEl.innerHTML += `<div class="suggestions">${suggestionsHTML}</div>`;
      }

      addLog(title + ': ' + message.replace(/<[^>]*>/g, ''), type);
    }

    // Inicializar navegador (CORRIGIDA - S√çNCRONA)
    function initBrowser() {
      try {
        // Detectar navegador IMEDIATAMENTE
        const browser = detectBrowser();
        const icon = browserIcons[browser] || 'üåê';
        const name = browserNames[browser] || 'Navegador Desconhecido';

        // Salvar na vari√°vel global
        detectedBrowser = browser;

        // Atualizar interface IMEDIATAMENTE
        document.getElementById('browserIcon').textContent = icon;
        document.getElementById('browserName').textContent = name;
        document.getElementById('browserPath').textContent = 'Cookies ser√£o extra√≠dos automaticamente';

        addLog(`Navegador detectado: ${name} (${browser})`, 'success');

        // Verificar status do servidor (ASS√çNCRONO, mas n√£o bloqueia)
        checkServerStatus();

      } catch (err) {
        console.error('Erro ao detectar navegador:', err);
        document.getElementById('browserName').textContent = 'Erro na detec√ß√£o';
        document.getElementById('browserPath').textContent = 'Usando Brave como padr√£o';
        detectedBrowser = 'brave';
      }
    }

    // Verificar status do servidor (SEPARADO)
    async function checkServerStatus() {
      try {
        const response = await fetch('/status');
        const data = await response.json();
        addLog(`Servidor online - ${data.files_count} arquivo(s) em cache`, 'info');
        
        if (data.navegadores_disponiveis && data.navegadores_disponiveis.length > 0) {
          addLog(`Navegadores no servidor: ${data.navegadores_disponiveis.join(', ')}`, 'info');
        }
      } catch (err) {
        addLog('Aviso: N√£o foi poss√≠vel conectar ao servidor', 'warning');
        updateStatus('Aviso', 'Servidor pode estar offline. Inicie com: npm start', 'warning');
      }
    }

    // Detectar plataforma da URL
    function detectPlatform(url) {
      const platforms = {
        'tiktok.com': { name: 'TikTok', icon: 'üì±' },
        'instagram.com': { name: 'Instagram', icon: 'üì∏' },
        'youtube.com': { name: 'YouTube', icon: '‚ñ∂Ô∏è' },
        'youtu.be': { name: 'YouTube', icon: '‚ñ∂Ô∏è' },
        'facebook.com': { name: 'Facebook', icon: 'üìò' },
        'fb.watch': { name: 'Facebook', icon: 'üìò' },
        'pinterest.com': { name: 'Pinterest', icon: 'üìå' },
        'pin.it': { name: 'Pinterest', icon: 'üìå' },
        'vimeo.com': { name: 'Vimeo', icon: 'üé•' },
        'twitter.com': { name: 'Twitter/X', icon: 'üê¶' },
        'x.com': { name: 'Twitter/X', icon: 'üê¶' }
      };

      for (const [domain, info] of Object.entries(platforms)) {
        if (url.includes(domain)) {
          return info;
        }
      }

      return { name: 'Desconhecida', icon: 'üåê' };
    }

    // Fun√ß√£o principal de download
    async function downloadVideo() {
      const url = document.getElementById('videoUrl').value.trim();
      const btn = document.getElementById('downloadBtn');
      const progressBar = document.getElementById('progressBar');

      if (!url) {
        updateStatus('Aten√ß√£o', 'Por favor, insira uma URL v√°lida.', 'warning');
        return;
      }

      const platform = detectPlatform(url);
      
      btn.disabled = true;
      btn.classList.add('loading');
      progressBar.classList.add('show');

      const mediaTypeNames = {
        'video_audio': 'V√≠deo e √Åudio',
        'audio_mp3': '√Åudio MP3',
        'audio_m4a': '√Åudio M4A',
        'video_only': 'Apenas V√≠deo'
      };

      updateStatus(
        'Iniciando Download',
        `Plataforma: ${platform.icon} <strong>${platform.name}</strong><br>` +
        `Tipo: <strong>${mediaTypeNames[selectedMediaType]}</strong><br>` +
        `Preparando download...`,
        'info'
      );

      addLog(`Iniciando download de: ${url}`, 'info');
      addLog(`Plataforma: ${platform.name}`, 'info');
      addLog(`Navegador: ${detectedBrowser}`, 'info');
      addLog(`Tipo de M√≠dia: ${mediaTypeNames[selectedMediaType]}`, 'info');

      try {
        const response = await fetch('/download', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            url, 
            browser: detectedBrowser,
            mediaType: selectedMediaType
          })
        });

        const data = await response.json();

        if (data.success) {
          const tentativas = data.tentativas > 1 ? ` (ap√≥s ${data.tentativas} tentativas)` : '';
          
          updateStatus(
            'Download Conclu√≠do!',
            `O arquivo foi baixado com sucesso${tentativas}! üéâ<br>
            <a href="/downloaded/${encodeURIComponent(data.file)}" download class="download-link">
              üì• Clique aqui para fazer o download
            </a>`,
            'success'
          );

          addLog(`Download conclu√≠do: ${data.file}`, 'success');
        } else {
          const suggestions = data.sugestoes || [];
          const errorMsg = data.error || 'Erro desconhecido ao processar o download';
          
          updateStatus(
            'Erro no Download',
            `<strong>${errorMsg}</strong><br><br>Plataforma: ${data.plataforma || platform.name}`,
            'error',
            suggestions
          );

          addLog(`Erro: ${errorMsg}`, 'error');
        }
      } catch (err) {
        updateStatus(
          'Erro de Conex√£o',
          `N√£o foi poss√≠vel conectar ao servidor.<br><strong>${err.message}</strong>`,
          'error',
          [
            'Verifique se o servidor est√° rodando (npm start)',
            'Confirme se a porta 3000 est√° acess√≠vel',
            'Tente recarregar a p√°gina'
          ]
        );

        addLog(`Erro de rede: ${err.message}`, 'error');
      } finally {
        btn.disabled = false;
        btn.classList.remove('loading');
        progressBar.classList.remove('show');
      }
    }

    // NOVO: Gerenciar sele√ß√£o de tipo de m√≠dia
    function setupMediaTypeButtons() {
      const buttons = document.querySelectorAll('.media-btn');
      
      buttons.forEach(button => {
        button.addEventListener('click', function() {
          // Remove active de todos
          buttons.forEach(btn => btn.classList.remove('active'));
          
          // Adiciona active no clicado
          this.classList.add('active');
          
          // Salva o tipo selecionado
          selectedMediaType = this.getAttribute('data-type');
          
          addLog(`Tipo de m√≠dia alterado para: ${this.querySelector('.title').textContent}`, 'info');
        });
      });
    }

    // Event Listeners
    document.getElementById('downloadBtn').addEventListener('click', downloadVideo);
    
    document.getElementById('videoUrl').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        downloadVideo();
      }
    });

    // Limpar logs ao colar nova URL
    document.getElementById('videoUrl').addEventListener('paste', () => {
      setTimeout(() => {
        document.getElementById('logs').innerHTML = '';
        document.getElementById('statusContainer').classList.remove('show');
      }, 100);
    });

    // Inicializar IMEDIATAMENTE ao carregar a p√°gina
    window.addEventListener('DOMContentLoaded', () => {
      console.log('üöÄ Iniciando aplica√ß√£o...');
      
      // Detectar navegador IMEDIATAMENTE (s√≠ncrono)
      initBrowser();
      
      // Configurar bot√µes de m√≠dia
      setupMediaTypeButtons();
      
      addLog('Interface carregada com sucesso', 'success');
      console.log('‚úÖ Aplica√ß√£o iniciada! Navegador detectado:', detectedBrowser);
    });
  </script>
</body>
</html>